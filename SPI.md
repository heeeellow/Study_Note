
# SPI协议学习笔记

---

## 1. SPI协议概述

* **SPI**是一种由Motorola提出的全双工、同步、主从式串行通信接口。
* 主要用于微控制器与各种外设（如Flash、显示屏、ADC/DAC、无线模块等）的高速短距离数据交换。

---

## 2. SPI硬件连接结构

### 2.1 四线制标准SPI

| 信号线  | 英文缩写  | 方向    | 作用     |
| ---- | ----- | ----- | ------ |
| 时钟   | SCLK  | 主 → 从 | 同步数据交换 |
| 主出从入 | MOSI  | 主 → 从 | 主机发数据  |
| 主入从出 | MISO  | 从 → 主 | 从机发数据  |
| 片选   | SS/CS | 主 → 从 | 选择设备   |

### 2.2 多从机连接方式

* **星型（独立片选）：** 每个从机一根CS线，主机点选通信，常用于功能各异、数目不多的外设。
* **菊花链（Daisy Chain）：** 从机的MOSI和MISO首尾串联，所有从机共用CS，数据像流水线一样推送和读取，常见于移位寄存器级联、LED阵列等。

---

## 3. SPI通信原理

### 3.1 同步通信

* 所有数据的读写都以SCLK时钟为基准，避免异步带来的不确定性。

### 3.2 全双工机制

* 数据在MOSI和MISO线上同时传输，实现边发边收，效率高。

### 3.3 时钟极性与相位（CPOL/CPHA）

* **CPOL（Clock Polarity）：** 时钟空闲电平（高/低）
* **CPHA（Clock Phase）：** 数据采样/切换的时钟沿
* 共4种组合，主从必须一致，否则数据会混乱。

---

## 4. SPI时序与数据传输

* 数据移位寄存器同步移位，常用8/16/32位一组。
* 片选线拉低期间，主机不断产生时钟，实现数据的移入移出。
* 多字节时可连续传输，部分外设可自动递增寄存器地址。

---

## 5. 菊花链SPI（Daisy Chain）

* 主机MOSI连第1个外设，依次串联至最后，MISO回主机。
* 全部外设CS线并联。
* 每发送一位数据，会经过每一级设备移位寄存器推送一位，主机读回的数据延后N级。
* 适合LED驱动、位扩展器等串联级联场合。

---

## 6. SPI与其他协议对比

| 协议   | 线数   | 速率  | 通信模式  | 适用场景      |
| ---- | ---- | --- | ----- | --------- |
| SPI  | 3\~N | 高   | 全双工   | 高速/短距离    |
| I2C  | 2    | 中/低 | 半双工   | 复杂总线/多主多从 |
| UART | 2    | 中/低 | 全/半双工 | 板间/异步     |

---

## 7. SPI嵌入式软件开发要点

### 7.1 常见寄存器配置

* 选择主/从模式
* 设置时钟极性/相位
* 选择字节长度
* 开启DMA加速（可选）
* 管理片选IO

### 7.2 常见软件接口

* 轮询（polling）：简单但CPU占用高
* 中断（interrupt）：CPU利用率高，实时性强
* DMA：数据量大时首选，几乎不占用CPU

### 7.3 可靠性问题

* 时钟漂移、线缆干扰、信号反射
* 线长受限，建议<1米
* 软件/硬件防抖，必要时加上拉/下拉

---

## 8. SPI常见外设与应用

* Flash存储器
* OLED/TFT显示屏
* 传感器（陀螺仪、加速度计、磁力计等）
* 无线模块（nRF24L01、CC1101）
* SD卡、DAC/ADC芯片
* 级联LED、移位寄存器（74HC595、WS2812等）

---

## 9. SPI快问快答

---

### 1. **问：请你详细说说SPI协议的通信原理，包括它的全双工机制和同步时序。**

**参考答案：**
SPI是一种主从同步串行通信协议。它通过SCLK时钟同步数据收发，每个时钟沿会在MOSI（主出从入）线上发出主机数据、在MISO（主入从出）线上收回从机数据，实现全双工通信。主机主导通信时序，片选信号选择目标外设，数据通过移位寄存器同步移入/移出，每次通信一般为8/16/32位一组，支持连续数据流传输。

---

### 2. **问：SPI的CPOL和CPHA分别是什么？这四种模式对时序有什么影响？**

**参考答案：**
CPOL为时钟极性，决定SCLK空闲时的电平（高或低）；CPHA为时钟相位，决定数据采样发生在时钟第一个还是第二个跳变沿。四种组合（CPOL/CPHA=00,01,10,11）决定数据采样和切换的精确时刻，必须主从一致，否则通信数据会错位或丢失。例如，CPOL=0,CPHA=0时，时钟空闲低电平，数据在第一个上升沿采样。

---

### 3. **问：SPI菊花链（Daisy Chain）模式和普通多片选模式的区别和应用场景是什么？**

**参考答案：**
普通多片选模式是主机为每个从机分配独立的CS线，MOSI/MISO/SCLK并联，主机只与被选中的从机通信。菊花链模式则是把多个外设首尾串联，主机的MOSI连第1从机，依次串联到最后，最后一个从机MISO再回主机，所有外设共用一根CS。菊花链适合级联移位寄存器、LED阵列等串联场合，极大简化片选线，但会产生数据延迟（传递到指定从机需要多次时钟移位）。

---

### 4. **问：如果你需要同时连接10个SPI外设，分别用星型和菊花链能怎么实现？各自优缺点？**

**参考答案：**
星型需要10根独立CS线，主机可随时访问任意外设，数据实时，配置简单，适合高实时性设备，但IO消耗大。菊花链只需1根CS，硬件布线更简洁，级联外设容易，但每个外设收/发数据时都需多次移位，延迟随设备数量线性增加，不适合对延迟敏感的应用。

---

### 5. **问：简述SPI的主机与从机的软件初始化流程，以及常见的开发bug。**

**参考答案：**
主机：配置IO（SCLK/MOSI/MISO/CS），初始化SPI外设（主/从、CPOL/CPHA、速率、数据宽度等），拉高CS。传输时拉低CS，发数据，同时收数据。
从机：配置IO及SPI外设，等待片选拉低开始响应。
常见bug：主从CPOL/CPHA不一致、CS信号处理不规范、发送/接收字节数不同步、线缆干扰或电平漂移、误用DMA或中断时机等。

---

### 6. **问：你如何实现一个通用的SPI驱动（C/裸机）？简述思路或流程。**

**参考答案：**

* 编写初始化函数，设置主/从、速率、极性相位、数据位宽等。
* 实现片选拉高/拉低的GPIO控制。
* 实现字节发送与接收函数（可用轮询/中断/DMA）。
* 封装多字节连续读写接口。
* 提供上层API屏蔽底层硬件细节，便于外设调用。
* 支持多从机或菊花链级联的片选与数据排序处理。

---

### 7. **问：SPI和I2C相比，各自优缺点及典型应用场景？**

**参考答案：**
SPI速度更快，全双工，硬件实现简单，适合高速数据传输和实时性要求高的场合（如Flash、SD卡、显示屏、无线模块）；I2C只用两根线，支持更多设备挂载，适合总线拓扑、设备数量多、速率要求不高的场合（如温度传感器、EEPROM、RTC等）。

---

### 8. **问：SPI软件模拟（Bit-banging）是什么？与硬件SPI相比有何优缺点？**

**参考答案：**
Bit-banging即用普通IO加软件时序模拟SPI通信，而不是用硬件SPI控制器。优点是任意IO可用、灵活性高、支持非标外设，缺点是CPU占用高、速率低、不稳定、不支持DMA等。

---

**End**
